<div class="container">
  <mat-card *ngIf="parametres.open !== null && !parametres.open">
    <h1 class="lobster center">Les inscriptions au tournoi sont fermées ...</h1>
  </mat-card>

  <mat-card *ngIf="parametres.open !== null && parametres.open">
    <p [innerHTML]="parametres.titre" class="center"></p>
    <h1 class="center lobster">{{ parametres.date | date : "dd/MM/yyyy" }}</h1>

    <p [innerHTML]="parametres.texte_debut | noSanitize"></p>

    <br />
    <h2 class="lobster">1. Inscription aux tableaux</h2>
    <div [innerHTML]="parametres.consignes_tableaux | noSanitize"></div>

    <div *ngFor="let joueurItem of listeJoueurs">
      <form>
        <div fxLayout="row" fxLayout.lt-md="column" class="form_inputs_player">
          <div fxFlex="25%" fxFlex.lt-md="100%">
            <mat-form-field appearance="outline" class="center">
              <mat-label
                [ngStyle]="{
                  color:
                    isInSameNamePlayers(joueurItem.nom) ||
                    isInAlreadySubscribedPlayers(joueurItem.nom) ||
                    hasNoName(joueurItem.nom) ||
                    hasNoTableau(joueurItem.tableaux)
                      ? 'red'
                      : 'black'
                }"
                >NOM Prénom *</mat-label
              >
              <input name="nom" [(ngModel)]="joueurItem.nom" matInput />
            </mat-form-field>
            <p
              class="error"
              *ngIf="
                isInSameNamePlayers(joueurItem.nom) &&
                !hasNoName(joueurItem.nom) &&
                !isInAlreadySubscribedPlayers(joueurItem.nom)
              "
            >
              Nom en doublon
            </p>
            <p
              class="error"
              *ngIf="
                isInAlreadySubscribedPlayers(joueurItem.nom) &&
                !hasNoName(joueurItem.nom)
              "
            >
              <b>{{ joueurItem.nom | uppercase }}</b> est déjà inscrit
            </p>
            <p class="error" *ngIf="hasNoName(joueurItem.nom)">
              Pas de nom renseigné
            </p>
            <p class="error" *ngIf="hasNoTableau(joueurItem.tableaux)">
              Aucun tableau(x) coché(s)
            </p>
          </div>

          <div fxFlex="25%" fxFlex.lt-md="100%">
            <mat-form-field appearance="outline" class="center">
              <mat-label>Points mensuels (si compétiteur)</mat-label>
              <input
                name="classement"
                [(ngModel)]="joueurItem.classement"
                type="number"
                min="0"
                max="2000"
                matInput
              />
            </mat-form-field>
          </div>

          <div fxFlex="15%" fxFlex.lt-md="100%">
            <mat-form-field appearance="outline" class="center">
              <mat-label>Âge (si mineur)</mat-label>
              <input
                (input)="typing(joueurItem)"
                name="age"
                [(ngModel)]="joueurItem.age"
                type="number"
                min="5"
                max="99"
                matInput
              />
            </mat-form-field>
          </div>

          <div fxFlex="20%" fxFlex.lt-md="100%">
            <mat-form-field appearance="outline" class="center">
              <mat-label>Tableau(x) *</mat-label>
              <mat-select
                name="tableaux"
                [(ngModel)]="joueurItem.tableaux"
                multiple
              >
                <mat-option
                  [disabled]="clickable(tableau, joueurItem.age)"
                  *ngFor="let tableau of tableaux"
                  [value]="tableau"
                  ><span
                    >{{ tableau.nom | titlecase }}
                    <span *ngIf="tableau.age_minimum !== null"
                      >-{{ tableau.age_minimum }} ans</span
                    ></span
                  ></mat-option
                >
              </mat-select>
            </mat-form-field>
          </div>

          <div fxFlex="15%" fxFlex.lt-md="100%">
            <button
              mat-raised-button
              (click)="removeItem(joueurItem)"
              class="center btn_action delete"
              color="warn"
            >
              Effacer ce joueur
            </button>
          </div>
        </div>
      </form>
    </div>

    <form>
      <div fxLayout="row" fxLayout.lt-md="column" class="form_inputs_player">
        <div fxFlex="25%" fxFlex.lt-md="100%">
          <mat-form-field appearance="outline" class="center">
            <mat-label>NOM Prénom *</mat-label>
            <input name="nom" [(ngModel)]="joueurData.nom" matInput />
          </mat-form-field>
        </div>

        <div fxFlex="25%" fxFlex.lt-md="100%">
          <mat-form-field appearance="outline" class="center">
            <mat-label>Points mensuels (si compétiteur)</mat-label>
            <input
              name="classement"
              [(ngModel)]="joueurData.classement"
              type="number"
              min="0"
              max="2000"
              matInput
            />
          </mat-form-field>
        </div>

        <div fxFlex="15%" fxFlex.lt-md="100%">
          <mat-form-field appearance="outline" class="center">
            <mat-label>Âge (si mineur)</mat-label>
            <input
              (input)="typing(joueurData)"
              name="age"
              [(ngModel)]="joueurData.age"
              type="number"
              min="0"
              max="99"
              matInput
            />
          </mat-form-field>
        </div>

        <div fxFlex="20%" fxFlex.lt-md="100%">
          <mat-form-field appearance="outline" class="center">
            <mat-label>Tableau(x) *</mat-label>
            <mat-select
              name="tableaux"
              [(ngModel)]="joueurData.tableaux"
              multiple
            >
              <mat-option
                [disabled]="clickable(tableau, joueurData.age)"
                *ngFor="let tableau of tableaux"
                [value]="tableau"
                ><span
                  >{{ tableau.nom | titlecase }}
                  <span *ngIf="tableau.age_minimum !== null"
                    >-{{ tableau.age_minimum }} ans</span
                  ></span
                ></mat-option
              >
            </mat-select>
          </mat-form-field>
        </div>

        <div fxFlex="15%" fxFlex.lt-md="100%">
          <button
            class="center btn_action"
            [disabled]="disabledAddPlayer(joueurData)"
            (click)="addJoueur(joueurData)"
            mat-raised-button
            color="primary"
          >
            Valider ce joueur
          </button>
        </div>
      </div>
    </form>
    <br />

    <br />
    <h2 class="lobster">2. Participation au buffet du soir</h2>
    <p [innerHTML]="parametres.texte_buffet | noSanitize"></p>

    <div class="nbParticipants">
      <h3 class="lobster">Nombre d'enfants au total</h3>
      <mat-form-field class="shorten" appearance="outline">
        <input
          matInput
          type="number"
          min="0"
          max="20"
          [(ngModel)]="buffet.enfant"
          name="enfant"
        />
      </mat-form-field>
    </div>

    <div class="nbParticipants">
      <h3 class="lobster">Nombre d'ados/adultes au total</h3>
      <mat-form-field class="shorten" appearance="outline">
        <input
          matInput
          type="number"
          min="0"
          max="20"
          [(ngModel)]="buffet.ado_adulte"
          name="ado_adulte"
        />
      </mat-form-field>
    </div>

    <div *ngIf="listeJoueurs.length">
      <br />
      <h3 class="lobster">Participation des joueurs au buffet</h3>

      <table mat-table [dataSource]="dataSource">
        <ng-container matColumnDef="nom">
          <th mat-header-cell *matHeaderCellDef>Nom</th>
          <td mat-cell *matCellDef="let joueur">{{ joueur.nom }}</td>
        </ng-container>

        <ng-container matColumnDef="buffet">
          <th mat-header-cell *matHeaderCellDef>Buffet</th>
          <td mat-cell *matCellDef="let joueur">
            <mat-slide-toggle
              color="primary"
              (change)="joueur.buffet = !joueur.buffet"
              [checked]="joueur.buffet"
            >
            </mat-slide-toggle>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['nom', 'buffet']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['nom', 'buffet']"></tr>
      </table>
    </div>

    <br />
    <h3 class="lobster title_plat">
      <b>Plat(s) <u>que vous aurez confectionné(s)</u></b>
    </h3>

    <p class="alerte_info">
      <mat-icon aria-hidden="false">info</mat-icon>
      <i>
        Écrivez <b>un</b> plat, puis appuyez sur la touche
        <strong>Entrée</strong> de votre clavier pour l'ajouter à la liste, et
        ainsi de suite <b>pour chaque plat</b>.</i
      >
    </p>

    <mat-form-field class="chip-list" appearance="outline">
      <mat-chip-list #chipList aria-label="Fruit selection">
        <mat-chip
          *ngFor="let plat of buffet.plats"
          [selectable]="selectable"
          [removable]="removable"
          (removed)="remove(plat)"
          color="primary"
          selected
        >
          {{ plat }}
          <mat-icon matChipRemove *ngIf="removable">cancel</mat-icon>
        </mat-chip>
        <input
          [matChipInputFor]="chipList"
          [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
          [matChipInputAddOnBlur]="addOnBlur"
          type="text"
          placeholder="Plats préparés"
          (matChipInputTokenEnd)="add($event)"
        />
      </mat-chip-list>
    </mat-form-field>

    <br />
    <p><i>Plats déjà préparés :</i></p>
    <mat-chip-list
      *ngIf="!platsAlreadyCookedEmpty(); else noPlatsAlreadyCooked"
    >
      <mat-chip
        *ngFor="let plat of platsAlreadyCooked"
        color="primary"
        selected
        >{{ plat }}</mat-chip
      >
    </mat-chip-list>
    <ng-template #noPlatsAlreadyCooked><p>(Aucun)</p></ng-template><br />

    <br />
    <h2 class="lobster">3. Validez le formulaire !</h2>

    <p class="alerte_pill center" *ngIf="isPlayerSubscribing()">
      Un joueur est en cours d'inscription et n'a pas été validé.<br /><i
        >(Rappel : cliquez sur le bouton bleu <b>Valider ce joueur</b> pour
        inscrire chaque participant.)</i
      >
    </p>
    <p class="alerte_pill center" *ngIf="hasSameNamePlayers().length > 0">
      {{ hasSameNamePlayers().length * 2 }} joueurs possèdent le même nom :
      différenciez-les par l'ajout d'un chiffre ou d'un surnom. <br />Pour
      rappel, si un joueur participe à plusieurs tableaux, cochez-les tous dans
      la liste des tableaux pour ce joueur.
    </p>
    <p
      class="alerte_pill center"
      *ngIf="listeJoueursHasInvalidPlayer().length > 0"
    >
      {{
        listeJoueursHasInvalidPlayer().length +
          (listeJoueursHasInvalidPlayer().length > 1
            ? " joueurs n'ont pas de noms renseignés"
            : " joueur n'a pas de nom renseigné")
      }}
      ou de tableau(x) coché(s)
    </p>
    <p class="alerte_pill center" *ngIf="isAlreadySubscribed().length > 0">
      {{
        isAlreadySubscribed().length +
          (isAlreadySubscribed().length > 1
            ? " joueurs renseignés sont déjà inscrits"
            : " joueur renseigné est déjà inscrit")
      }}
    </p>
    <button
      [disabled]="disabledSubmit()"
      class="center"
      mat-raised-button
      color="primary"
      (click)="openConfirmModale()"
    >
      <mat-icon *ngIf="spinnerShown">
        <mat-spinner color="accent" [diameter]="20"></mat-spinner>
      </mat-icon>
      Envoyer !
    </button>
    <br />
    <br />

    <div [innerHTML]="parametres.texte_fin | noSanitize"></div>
    <br />
  </mat-card>
</div>
